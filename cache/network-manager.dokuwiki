{{tag>Xenial internet réseau wifi}}

----

 ====== Utilitaire de gestion des connexions réseau Network-Manager ======


**Network-Manager** est l'outil de gestion des connexions réseau d'Ubuntu.
{{  :network-manager:network-managerlogo_trusty.png}}
<note>Depuis quelques années, le tiret n'existe plus et le service se nomme desormais NetworkManager (attention à la casse lorsqu'on tape une commande) </note>
Son utilité est la création et la configuration des accès à divers types de réseaux (Internet, réseau local [LAN], réseau privé virtuel [VPN]...). Network-Manager peut prendre en charge de nombreux types de connexions (réseau filaire, réseau sans-fil [Wi-Fi], modem téléphonique, réseau mobile, réseau privé virtuel...). Network-Manager peut aussi être utilisé pour partager une connexion réseau (généralement Internet) à d'autres ordinateurs de votre réseau local.


===== Installation / réinstallation =====
Network-Manager est installé par défaut. Dans Ubuntu et dans Kubuntu, il prend la forme d'une applet, une petite icône située dans le tableau de bord.\\
Il est possible que Network-Manager se soit désinstallé dans votre système ; c'est le cas, entre autres, lorsque vous installez un autre gestionnaire de connexions réseau (comme [[:Wicd]]). Pour réinstaller Network-Manager, [[:tutoriel:comment_installer_un_paquet|installez]] l'un des paquets suivants :
  * //Pour Ubuntu :// **[[apt>network-manager-gnome]]** ;
  * //Pour Kubuntu :// **[[apt>plasma-widget-networkmanagement]]** ;
  * //Pour Kubuntu (à partir de 14.04):// **[[apt>plasma-nm]]**;
  * //Pour Kubuntu (à partir de 18.04?):// **[[apt>network-manager]]**.
===== Utilisation =====
L'applet de Network-Manager se trouve automatiquement dans la zone de notification de votre tableau de bord. C'est à travers cette applet que vous pouvez gérer les connexions réseau de votre ordinateur. L'applet prend différents états en fonction de votre connexion (connecté / non connecté, réseau filaire / réseau sans fil, etc.)

| Aucun réseau connecté  | {{:network-manager:network-offline.png|Icône sous Ubuntu 14.04 LTS}} |
| Réseau filaire connecté  | {{:network-manager:network-wired.png|Icône sous Ubuntu 14.04 LTS}} |
| Réseau sans fil connecté  | {{:network-manager:network-wireless.png|Icône sous Ubuntu 14.04 LTS}} |

Si l'applet n'apparaît pas dans votre tableau de bord ou si elle vous indique le message d'erreur //Network-Manager n'est pas lancé...//, [[#verifier_que_le_service_est_en_fonction|vérifiez que le service Network-Manager est en fonction]].

Sous [[:gnome-session-fallback|Gnome classique]] et [[:Mate]] si l'applet n'apparaît plus suite à une suppression par erreur:
     - Clic droit sur le tableau de bord,
     - Sélectionner "Ajouter au tableau de bord",
     - Chercher "Zone de notification" puis cliquer sur "Ajouter".

====Se connecter/déconnecter à un réseau détecté déjà configuré ====
{{  :network-manager:networkmanager-listeconnexions.png?200|Affichage des connexions réseau actuelles dans Network-Manager (Ubuntu 14.04 LTS)}}
\\
Un clic sur l'applet permet d'afficher les réseaux disponibles (notamment les réseaux sans fil détectés à portée, si votre ordinateur est équipé d'un adaptateur sans fil activé). Sélectionnez le réseau auquel vous désirez vous connecter.
\\
Ce menu vous offre aussi la possibilité :
  * D'établir une connexion à un réseau sans fil invisible (qui ne diffuse pas son existence), lorsque votre ordinateur est doté d'un émetteur-récepteur de réseaux sans fil ;
  * [[:telephone_modem|De configurer une connexion mobile à large bande]] (par réseau cellulaire 3G+, 3G, Edge, EV-DO), si votre ordinateur est relié à votre téléphone portable (GSM) ou à une clé mobile fournie par votre fournisseur d'accès à Internet ;
  * De paramétrer des [[:vpn|connexions réseaux privés virtuels (VPN)]], afin d'accéder à votre réseau d'entreprise depuis votre ordinateur à la maison ou depuis votre ordinateur portable lorsque vous êtes en déplacement.

Dans ce même menu, vous apercevez une ou des entrées **Se déconnecter**. Ces entrées permettent de couper la connexion désignée. Votre ordinateur ne sera ainsi plus relié au réseau mentionné.
\\
====Configurer de nouveaux réseaux ou modifier des réseaux existants====
Pour configurer des réseaux, que ce soit l'ajout de nouveaux réseaux ou la modification de réseaux existants, faites un clic sur l'applet de Network-Manager et sélectionnez l'entrée de menu **Modification des connexions...**.
{{ :network-manager:ntwconfig_trusty.png?200|Interface de modification des connexions réseau}}
  * Pour ajouter une nouvelle connexion:
    * Cliquez sur **Ajouter** : une fenêtre s'ouvre qui vous demande de choisir le type de connexion à créer (filaire, sans fil, connexion mobile, VPN ou DSL...),
    * Une autre fenêtre s'ouvre, saisissez les informations relatives à votre connexion réseau, puis appuyez sur le bouton **Enregistrer** pour ajouter votre nouvelle connexion à la liste de celles disponibles ;
  * Pour modifier une connexion existante, sélectionnez la connexion que vous souhaitez modifier, cliquez sur le bouton **Modifier** : une interface identique à celle de l'ajout d'une nouvelle connexion s'ouvre, mais avec certains champs d'informations pré-remplis. Modifiez les informations de votre choix, puis appuyez sur le bouton **Appliquer** pour que les changements soient pris en compte.
  * Pour supprimer une connexion, sélectionnez la connexion à supprimer et cliquez sur le bouton **Supprimer**.

==== Lier une connexion à une interface réseau précise ====
FIXME La suite nécessite quelques précisions.
Par défaut, une connexion d'un certain type est disponible pour l'ensemble des interfaces compatibles. Par exemple, si votre ordinateur dispose de deux cartes réseau filaire Ethernet, alors l'ensemble des connexions filaires que vous avez paramétrées sont disponibles pour ces deux cartes. Vous pouvez vouloir limiter certaines connexions à une seule interface (ce qui est utile, par exemple, pour paramétrer le partage de connexion réseau). Pour limiter la disponibilité d'une connexion à une seule interface de réseau, précisez l'adresse MAC de l'interface à laquelle elle doit être liée. 
Pour ce faire, vous devez d'abord découvrir l'adresse MAC de vos interfaces réseau.
  - Ouvrez un [[:terminal]] et exécutez la commande suivante : <code>ip addr</code> L'ensemble de vos interfaces réseau connues et actives sont alors listées ;
  - Localisez l'interface réseau à laquelle vous voulez lier une connexion. Notez le champ **link/ether** pour cette connexion : c'est son adresse MAC ;
  - Rendez-vous ensuite dans l'interface d'ajout ou de modification d'une connexion. Inscrivez l'adresse MAC de l'interface correspondante dans le champ //Adresse MAC// ;
  - Appuyez ensuite sur le bouton **Appliquer** pour prendre en compte la modification.

<note>Un modérateur devrait remplacer la capture de ifconfig par une capture de ip addr afin de mettre la doc à jour</note>
{{:networkmanager-connexionliee1.png?344x216|Récupérez l'adresse physique (HwAddr) de votre carte réseau}}     {{:networkmanager-connexionliee2.png?200x216|Inscrivez-la dans le champ "Adresse MAC" (ici, pour une connexion filaire)}}     {{:networkmanager-connexionliee3.png?200x216|Inscrivez-la dans le champ "Adresse MAC" (ici, pour une connexion sans fil)}}


==== Gérer les adresses IP ====
{{ :network-manager:networkmanager_ipautomatique_trusty.png?250|Configuration d'une connexion filaire pour l'obtention d'une adresse IP automatique (DHCP)}}

Pour vous connecter à votre réseau local ou à internet, votre ordinateur doit être dotée d'une adresse IP. L'adresse IP est un identifiant numérique unique qui identifie votre ordinateur parmi tous les autres ordinateurs de votre réseau ou d'internet. L'attribution de cette adresse IP unique peut se produire de plusieurs façons ; au moment d'établir la connexion au réseau désiré, un serveur envoie à votre ordinateur son adresse IP unique. Par défaut c'est la configuration automatique qui est activée. Si vous avez changé ces paramètres et que vous souhaitez revenir à une adresse ip automatique:
  * Rendez-vous dans l'onglet //Paramètres IPv4// de l'interface de gestion de votre connexion ;
  * Dans le champ //Nom de la connexion//, entrez un nom unique significatif pour votre connexion ;
  * Dans le menu déroulant //Méthode//, choisissez la méthode **Automatique (DHCP)** ;
  * Appuyez sur le bouton **Appliquer...** pour valider la modification.


Vous pouvez aussi paramétrer manuellement l'adresse IP attribuée à votre ordinateur. Ceci est particulièrement intéressant pour les serveurs, qui doivent sans cesse rester joignables à la même adresse pour tous les clients. Une configuration manuelle des adresses IP peut aussi accroître la sécurité de votre réseau local. Cependant, ce paramétrage est plus complexe, difficile à maintenir et long à appliquer à une grande infrastructure. Vous devriez laisser cette tâche à un administrateur réseau.
|Configuration d'une connexion à adresse IP statique}}
Pour paramétrer une connexion devant avoir une adresse IP fixe (au moment de créer une nouvelle connexion ou en modifiant une connexion existante) :
{{ :network-manager:networkmanager_ipfixe_trusty.png?250}}
  * Rendez-vous dans l'onglet //Paramètres IPv4// de l'interface de gestion de votre connexion ;
  * Dans le champ //Nom de la connexion//, entrez un nom unique significatif pour votre connexion ;
  * Dans le menu déroulant //Méthode//, choisissez la méthode **Manuel** ;
  * À la droite du cadres //Adresses//, appuyez sur le bouton **Ajouter** ;
  * Dans le cadre //Adresse//, inscrivez l'adresse IP : //192.168.1.23//, le masque de sous-réseau : //255.255.255.0// et (accessoirement) la passerelle:  //192.168.1.1// par défaut que doit utiliser votre connexion ;
  * Dans le champ //Serveurs DNS//, inscrivez la ou les adresses des serveurs DNS que doit utiliser votre connexion, par exemple //192.168.1.1//. Séparez les adresses multiples par une virgule ;
  - Dans le champ //Domaine de recherche//, inscrivez le domaine dans lequel votre connexion doit rechercher automatiquement des adresses, si tel est le cas ;
  - Appuyez sur le bouton **Appliquer...** pour appliquer les changements.
  - Cochez la case //Requiert un adressage ipv4 pour que cette connexion fonctionne//.

Avec une AliceBox, il faut en plus rajouter dans l'onglet 'Paramètres Ipv4' l'IP du DNS principal soit 213.36.80.1. La machine apparaît bien dans l'interface Web du routeur menu 'ARP' mais pas dans le menu 'DHCP'.


==== Modifier les paramètres IP pour la liaison de deux ordinateurs seulement ====

<note tip>Ne pas oublier que la connexion directe de deux périphériques Ethernet (par exemple la connexion de deux ordinateurs) nécessite le recours à un câble croisé. Si l'on n'en dispose pas, le recours à un commutateur (Ethernet Switch) ou à un routeur (Router) est nécessaire, car ces appareils gèrent automatiquement la reconnaissance des câbles droits ou croisés et s'y adaptent. Dans ce cas, il sera probablement possible de faire bénéficier plusieurs périphériques du partage de la connexion.</note>

{{ :network-manager:networkmanager-iplienlocal_trusty.png?250|Configuration d'une connexion de type lien-local}}

Vous pouvez paramétrer votre connexion pour qu'elle utilise une adresse réservée à une connexion locale temporaire uniquement. Ceci est particulièrement utile lorsque vous reliez temporairement deux ordinateurs l'un à l'autre ou lorsque vous reliez votre ordinateur directement à un disque de stockage réseau ([[:NAS]]). Des adresses temporaires sont automatiquement assignées à vos ordinateurs. Ce type de connexion est appelée "lien local".

Pour paramétrer une connexion de type lien local (au moment de créer une nouvelle connexion ou en modifiant une connexion existante) :
  - Rendez-vous dans l'onglet //Paramètres IPv4// de l'interface de gestion de votre connexion (Fenêtre Connexions réseau, sélectionner la connexion et cliquer sur modifier) ;
  - Dans le champ //Nom de la connexion//, entrez un nom unique significatif pour votre connexion ;
  - Dans le menu déroulant //Méthode//, choisissez la méthode **Lien-local** ;
  - Appuyez sur le bouton **Appliquer...** pour appliquer la modification.


==== Modifier les paramètres IP pour le partage d'une connexion Internet====
{{ :network-manager:networkmanager-ippartage_trusty.png?250|Configuration d'une connexion pour le partage de connexion}}

Vous pouvez paramétrer votre connexion pour qu'elle serve de pont entre plusieurs réseaux. Le plus fréquemment, cette configuration se rencontre lorsque l'ordinateur sous Ubuntu est relié directement au modem du fournisseur d'accès à Internet, et que l'on désire partager cet accès à Internet avec un autre ordinateur.

Ce genre de configuration nécessite que votre ordinateur dispose d'au moins deux cartes réseau (par exemple, une connexion filaire vers votre modem et une connexion sans fil vers votre réseau local). La connexion vers un réseau extérieur doit être de type automatique (DHCP), manuelle (IP statique) ou lien-local. La connexion vers votre réseau local doit être de type partagée avec d'autres ordinateurs ; c'est celle-ci que nous configurons ici.

Pour paramétrer une connexion partagée avec d'autres ordinateurs de votre réseau local (au moment de créer une nouvelle connexion ou en modifiant une connexion existante) :
  - Dans le champ //Nom de la connexion//, entrez un nom unique significatif pour votre connexion ;
  - Dans l'onglet //Wi-Fi// dans le champs //Mode// choisissez **Ad hoc**;
  - Rendez-vous dans l'onglet //Paramètres IPv4// de l'interface de gestion de votre connexion (Fenêtre Connexions réseau, sélectionner la connexion et cliquer sur modifier) ;
  - Dans le menu déroulant //Méthode//, choisissez la méthode **Partagée avec d'autres ordinateurs** ;
  - Allez ensuite dans l'onglet //Paramètres IPv6// et mettez la //Méthode// en //Ignorer//.
  - Appuyez sur **Appliquer...** pour activer le partage.

Il se peut que la connexion se connecte puis se déconnecte puis se reconnecte, en boucle. Si cela vous arrive, il suffit:
  - D'aller dans les paramètres de la seconde connexion (celle qui est reliée à internet) et faites comme pour la connexion partagée, ignorez IPv6. (//Paramètres IPv6//->//Méthode//->//Ignorer//)
  - D'appuyer sur le bouton **Appliquer...** pour valider la modification.

Vous aurez peut être besoin de redémarrer si la connexion fait encore des siennes.

Du côté des autres ordinateurs qui accèdent à votre connexion partagée, vous devez vous assurer que leur mode de connexion est paramétrée au type automatique (DHCP). Dans ce type de configuration, votre ordinateur sous Ubuntu se charge d'attribuer des adresses IP uniques à vos autres ordinateurs de votre réseau local.

<note tip>Il se peut qu'après avoir tout bien paramétré, Internet ne soit toujours pas accessible sur les ordinateurs avec lesquels vous souhaitez partager votre connexion. Ceci est probablement dû à un problème de configuration DNS.

Pour corriger ce problème, il suffit d'indiquer les paramètres correspondants sur les clients concernés.
  * Allez dans l'onglet **Paramètres IPv4**,
    * Dans **Méthode** choisissez **Adresse automatiques uniquement (DHCP)**,
    * Dans la case **Serveur DNS**, indiquez le serveur DNS de votre choix (par exemple celui de votre Fournisseur d'accès Internet ou celui de Google - 8.8.8.8),
    * Dans la case **Domaines de recherche**, indiquez par exemple celui de Google - 8.8.4.4.
</note>

===== Utilisation avancée =====

==== Voir l'état des réseaux actuellement connectés ====

{{  :network-manager:nm-info_trusty.png?200|Informations de connexions pour les réseaux actuellement connectés}}

Lorsque vous êtes connecté à un ou plusieurs réseaux, Network-Manager peut vous en indiquer les caractéristiques. Pour ce faire, faites un clic sur l'applet de Network-Manager et sélectionnez l'entrée de menu **Informations sur la connexion** //(voir l'image ci-contre)//.

==== Network Manager en mode pseudo graphique ====

<note tip>Cet utilitaire permet d'éviter de modifier les fichiers de configuration de network Manager et d'utiliser les lignes de commandes.</note>
<note>Cet utilitaire n'existe pas jusqu'à la version Ubuntu 14.04 incluse.</note>

Network-Manager est fourni avec un petit utilitaire permettant de gérer les connexions dans un environnement pseudo graphique. Cet utilitaire est extrêmement pratique pour les serveurs qui ne disposent pas d'interfaces graphiques. Inclus dans le paquet par défaut de network manager, il est aussi disponible sur les ordinateurs standards. Il permet d'effectuer les mêmes actions que via les différentes interfaces graphiques.

Lancement de l'application à partir d'un terminal :

<code>nmtui</code>

Naviguer dans l'application :
  * Les touches de direction permettent de naviguer dans les options.
  * La touche « entrée » permet de valider.
  * La touche « echap » permet de revenir en arrière sur les écrans.
  * La touche « espace » permet de cocher ou décocher les cases à choix.

Les captures d'écran suivantes vous donnent un aperçu des principaux écrans disponibles. Pour configurer les différentes connexions disponibles, vous pouvez vous référer aux paragraphes précédents, les options à renseigner sont les mêmes, seule la disposition change.

{{network-manager:nmaccueil.png?200|Menu principal}}  {{network-manager:nmgestionconnexion.png?200|Gestion des connexions}}  {{network-manager:nmparametre.png?200|Gestion des paramètres}}  {{network-manager:nmactivation.png?200| Activation - désactivation des connexions}}  {{network-manager:nmhost.png?200|Modification du host}} 

==== Modifier les fichiers de configurations d'une connexion ====
<note tip>Essayer d'abord la méthode décrite ci dessus, avant de modifier manuellement ces fichiers.</note>
Le fichier de configuration d'une connexion se trouve dans le dossier ''/etc/NetworkManager/system-connections''. Elles sont utiles, entre autre, pour récupérer les paramètres d'une ancienne Ubuntu sur une autre partition.

Après importation, si les connexions automatiques ne fonctionnent pas, indiquez le nom de la carte réseau à utiliser dans //Connexions réseaux → Modification des connexions… → nom_de_la_connexion_concernée → **Adresse MAC du périphérique**.//

Dans certains cas, il peut être intéressant de modifier directement les configurations des cartes réseau, sans passer par l'​interface graphique (problèmes graphiques, applet ne fonctionnant pas etc.)

Le fichier porte le nom de la connexion qui est affichée dans le Network-manager. Il est possible de modifier directement le fichier de configuration. Pour cela, un simple éditeur de texte suffira avec les [[:sudo|droits d'administration]]. Pour commenter une ligne, il faut mettre le symbole # en début de ligne:
<code>​sudo vim Connexion_filaire_1</code>

Exemple de fichier: 

<file>​[802-3-ethernet] ​
mac-address=74:​D4:​35:​84:​C0:​AE ​
[connection] ​
id=Connexion filaire 1 
uuid=622e166d-56e9-4a4a-9ed4-6cd5456482f0 ​
type=802-3-ethernet ​

[ipv6] ​
method=auto ​

[ipv4] ​
method=auto ​
#​dns=212.27.40.241;​212.27.40.240;​ #serveur dns de Free
ignore-auto-dns=false
</file>​

Après les modifications,​ il est nécessaire de relancer la carte réseau. Pour cela il faut lancer ces 2 commandes : 
<code>​sudo ip link set [nom de la carte] down #désactive la carte réseau
sudo ip link set [nom de la carte] up # active la carte réseau
</code>​
Pour obtenir le [nom de la carte], un 'ip addr'  vous donnera les informations :​ la mac-address du fichier correspond à link/ether de la commande ip addr: <code>​ip addr</code>​

====Network-Manager en ligne de commande ====
Pour démarrer le service: <code>sudo systemctl start NetworkManager </code>
Pour arrêter le service: <code>sudo systemctl stop NetworkManager</code>

Network-Manager peut aussi se contrôler depuis un [[:terminal]] (si l'on a plus accès à X par exemple) avec la commande :
<code>nmcli</code>
Voici quelques commandes utiles:
  * **nm-tool** affiche les informations sur vos connexions actives plus clairement que la commande **ifconfig**
  * **nmcli con show** liste de toutes les connections configurées via NetworkManager.
  * **nmcli con show uuid "UUID de la connexion"** ou **nmcli con show id "ID de la connexion"** permettent d'obtenir tous les détails liés à une connexion en particulier.
  * **nmcli con down id "nom de la connexion"** désactive la connexion.
  * **nmcli con up id "nom de la connexion"** active la connexion.
  * **nmcli con delete id "nom de la connexion"** supprime la configuration et la connexion.

<note>La commande nm-tool a été abandonnée pour cause de bugs divers. L'intégralité des fonctions est reprise par nmcli.</note>
==== Lancer automatiquement une connexion ou non ====

Clic sur l'applet de Network-Manager puis "Modification des connections", choisir le réseau à modifier, clic sur //Modifier...// Dans l'onglet //Général// cochez ou décochez la case //Se connecter automatiquement à ce réseau si disponible//.

====Désactiver Network-Manager pour laisser agir ifup====

Debian et Ubuntu diffèrent sur la manière de gérer leur réseau :
  * Debian utilise ifup/ifdown
  * Ubuntu utilise NetworkManager
 
Avec Debian, le système gère sa configuration avec l'utilitaire ''ifup'' et les données sont présentes dans le fichier de configuration situé à ''/etc/network/interfaces'', qui permet des configurations extrêmement complexes de mode serveur ou très avancées, dont nous n'avons généralement pas besoin sur un poste client, ou sur un ordinateur personnel. \\
On peut avoir à gérer une carte réseau à l'aide du fichier situé dans ''/etc/network/interfaces'', cependant, dans les dernières versions d'Ubuntu, il est nécessaire de passer par le démon système NetworkManager afin de gérer la configuration réseau. C'est la manière standard de procéder désormais.

Voici donc comment désactiver le service système NetworkManager qui gère le réseau pour une carte ou pour une interface réseau, et pouvoir pour celle-ci uniquement revenir à l'utilisation du fichier ''/etc/network/interfaces'' sous Ubuntu. D'abord, éditer la configuration de network-manager : 
<code>sudo nano /etc/NetworkManager/NetworkManager.conf</code>
Et procéder aux modifications comme suit : 

{{:disable_network_manager_ubuntu_1_thumb.png|}}

Puis on peut ensuite renseigner sa configuration IP dans le fichier interface pour la carte réseau concernée : 
<code>sudo nano /etc/network/interfaces</code>

ou encore
<code>auto eth0
iface eth0 inet static
address 192.168.0.118
netmask 255.255.255.0
gateway 192.168.0.1
</code>

ou encore
<code># The primary network interface
auto p5p1
iface p5p1 inet dhcp
</code>

ou encore
<code>auto p5p1
iface p5p1 inet static
address 192.168.1.1
netmask 255.255.255.0
gateway 192.168.1.2
</code>

Après redémarrage ou reconnexion, on obtient le résultat suivant : 
{{:disable_network_manager_ubuntu_3_thumb.png|}}
//Crédits de ce tutoriel dans les liens de la page.//

==== Se connecter à un réseau VPN ====

[[:tutoriel:comment_installer_un_paquet|Installez les paquets]] **[[apt>network-manager-openvpn,network-manager-openvpn-gnome,network-manager-pptp,network-manager-vpnc]]**.

<note help>Il est possible d'installer un seul des trois paquets si vous utilisez un seul de ces protocoles.</note>

Pour configurer votre réseau, cliquez sur l'icône de Network-Manager et ouvrez //Modification des connexions// et cliquez sur //Ajouter//.
Choisissez le protocole //vpn// que vous souhaitez créer et lancer la configuration. Si vous ne voyez pas dans la liste déroulante les différents protocoles installés, il est conseillé de redémarrer le service **Network-Manager**. Pour plus d'information sur la configuration, vous pouvez visiter cette page [[:vpn]].\\

Il faut penser également à donner une route au tuyau vpn, sinon tout le trafic passe par le vpn, le flux internet aussi. Le résultat est que lorsque vous êtes connecté au VPN, vous n'aurez plus internet. \\
Pour résoudre cela, l'onglet //Paramètres IPv4// de  votre connexion VPN, cliquez sur //Routes// cochez la case //Utilisez cette connexion uniquement pour les ressources de son réseau//, comme  [[:network-manager#dans_le_cas_ou_le_trafic_est_redirige_vers_la_mauvaise_carte|ci-dessus]].

<note tip>Vous trouverez à cette [[https://geekeries.de-labrusse.fr/?p=235|adresse, "Linux et Geekeries",]] un exemple de configuration graphique du module OpenVPN de Network-Manager à partir d'un serveur openvpn sur la SME-server.
</note>

D'autre part, si vous comptez vous connecter en ligne de commande via [[:SSH]], à un réseau déjà enregistré dans la configuration de l'applet Network-Manager, c'est possible, avec [[#Network-Manager en ligne de commande|nm-cli]].

Cependant, dans le cadre d'une connexion VPN, pour OpenVPN, il faudra [[:tutoriel:comment_modifier_un_fichier|ouvrir le fichier]] de configuration **/etc/NetworkManager/system-connections/votre-connexion-vpn** de la connexion existante avec [[:sudo|les droits d'administrateur]] et y modifier/rajouter ceci dans les bonnes sections :
<file>
[vpn]
password-flags=0

[vpn-secrets]
password=votre-mot-de-passe
</file>

Puis utilisez la commande : <code>sudo nmcli con up id nom-de-votre-connexion</code>

Sans ces manipulations, vous aurez droit à un beau 
<code>Erreur : l'activation de la connexion a échoué : Not authorized to control networking.</code>

Si tout est bon, le message suivant s'affichera :
<code>
état : Connexion VPN (authentification requise) (2)
état : Connexion VPN (3)
état : Connexion VPN (obtention de la configuration IP) (4)
Connexion activée
</code>

==== Gestion du serveur proxy ====
Network-Manager ne gère pas nativement la configuration du serveur proxy. Cependant, vous pouvez gérer votre proxy, via //Paramètres système > Réseau > Serveur mandataire//. Pour plus d'information reportez-vous à la page [[:proxy]].

==== Export des configurations ====
Les configuration de network-manager sont stockées dans <code>/etc/NetworkManager/system-connections/</code>
Il suffit de copier-coller le contenu de ce dossier sur une nouvelle machine pour retrouver ses connexions.

Les droits sur les fichiers doivent être configurés comme ceci : ''-rw------- 1 root root''. Soit propriétaire : root, groupe : root, droit de lecture et écriture pour le propriétaire et aucun droits pour les autres.

À la fin de la procédure il faut relancer networkmanager en fermant la session.

<note important>Attention à conserver ces fichiers de façon sécurisée car les clés wifi peuvent être inscrites en clair</note>
===== Problèmes connus =====

==== Aucun réseau détecté ====
Dans le cas où Network-Manager ne détecte aucun réseau alors qu'il devrait en détecter automatiquement au moins un, il est vivement conseillé de commencer par vérifier sa configuration matérielle. Ceci inclut :
  * Votre fil réseau est-il bien branché dans la fiche de votre carte réseau ? et dans votre modem-routeur ?
  * Votre adaptateur de réseau sans fil est-il sous tension ?
  * Votre carte réseau est-elle reconnue ?
  * //Consultez [[:reseau|le portail "Réseau"]] pour une plus ample aide à la configuration de votre carte réseau.//

==== Réseau sans fil invisible ====
Sous kubuntu, pour se connecter à un réseau wifi caché (qui ne diffuse pas son SSID), il faut :
  - Paramétrer la connexion avec knetwork-manager 
    - Gérer les connexions...
    - Onglet sans fil
    - Ajout
    - Remplir le champs SSID, choisir le mode infrastructure
    - Spécifier la sécurité du réseau sans fil et rentrer le mot de passe.
  - Dans une console, exécuter la commande :
<code>
sudo iwconfig wlan0 essid NOM_DU_RESEAU_CACHE
</code>
en remplaçant NOM_DU_RESEAU_CACHE par le SSID qui n'est pas diffusé.

==== Donner le contrôle du réseau à Network-Manager ====

Network-Manager peut ne pas fonctionner automatiquement juste après l'installation. Le mode itinérant (découverte automatique des réseaux) doit être activé sur vos interfaces (ethernet, Wi-Fi) , si ce n'est pas le cas, Network-Manager considère que vous avez réalisé une configuration manuelle et ne gérera pas ces connexions. Pour permettre la gestion des connexions réseaux par Network-Manager suivez ces manipulations :

Faites une sauvegarde du fichier **etc/network/interfaces** : <code>sudo cp /etc/network/interfaces /etc/network/interfaces.save</code>


<note tip>
Vous pouvez utiliser la commande suivante afin de réaliser l'opération de remise à zéro en une seule fois : <code>echo -e 'auto lo\niface lo inet loopback\n' | sudo tee /etc/network/interfaces</code>
</note>

[[:tutoriel:comment_editer_un_fichier|Éditez le fichier]] **/etc/network/interfaces**. Supprimez toutes les lignes autres que les 2 lignes suivantes : 
<file>
auto lo
iface lo inet loopback
</file>


En cas de problème, vous pouvez revenir facilement à la configuration précédente en restaurant l'ancien fichier de configuration : <code>sudo cp /etc/network/interfaces.save /etc/network/interfaces</code>

==== nm-applet renvoie une erreur ====

=== Erreur affichée par clic gauche sur nm-applet ===
> %%NetworkManager n'est pas lancé...%%
Tapez alors en ligne de commande :<code>sudo service network-manager restart</code>

Votre connexion va alors redémarrer et vous pourrez à nouveau gérer vos réseaux avec nm-applet.

=== Erreur sur les droits ===
Si nm-applet renvoie cette erreur :

> %%WARNING **: <WARNING>   (): nmwa_dbus_init() could not acquire its service.  dbus_bus_acquire_service() says: 'Connection ":1.26" is not allowed to own the service "org.freedesktop.NetworkManagerInfo" due to security policies in  the configuration file'%%

Ceci signifie que votre compte utilisateur n'a pas les droits nécessaires pour prendre la main sur votre matériel réseau. Il vous faudra alors ajouter votre utilisateur au groupe « netdev » comme ceci : <code>sudo usermod -G netdev -a <nom_utilisateur></code>

Enfin, redémarrez le service pour que vos nouveaux droits soient pris en compte : <code>sudo /etc/init.d/dbus restart</code>

Relancez alors ''nmapplet''.

=== Erreurs liées aux ressources ===
Si nm-applet renvoie cette erreur :
> The NetworkManager applet could not find some required resources.  It cannot continue
Il suffit d'ouvrir un terminal et d'y entrer : <code>sudo gtk-update-icon-cache -f /usr/share/icons/hicolor</code>

Maintenant cela devrait fonctionner.

Il ne reste plus qu'à configurer le réseau //via// l'icône dans la zone de notification.



==== Perte de connexion internet au démarrage avec des connexions réseaux statiques ====
Dans le cas où vous constatez des pertes de connexion internet au démarrage d'Ubuntu et que vous utilisez une ou plusieurs connexions réseaux statiques, [[:tutoriel:comment_modifier_un_fichier|éditez]] avec les [[:sudo|les droits d'administration]] le fichier **/etc/resolv.conf** et remplissez-le comme ceci :
<file>
   nameserver <IP_DNS_1>
   nameserver <IP_DNS_2>
   nameserver <IP_DNS_3>
   ... 
   domain <VOTRE_DOMAINE_DNS>
</file>
Ensuite [[:tutoriel:comment_installer_un_paquet|Installez le paquet]] **[[apt>resolvconf]]** et copiez avec [[:sudo|les droits d'administration]] le fichier **/etc/resolv.conf** que vous avez créé vers le fichier **/etc/resolvconf/resolv.conf.d/base**.


=== Dans le cas ou le trafic est redirigé vers la mauvaise carte ===
Vous avez un PC avec deux cartes réseaux (eth0 et eth1), eth0 est reliée à la box internet, eth1 est reliée à un autre PC (contrôle parental avec [[:dansGuardian]]).\\
La configuration des cartes s'est bien passée (eth0 en DHCP et eth1 en manuel).

Lorsque eth1 est débranchée, tout se passe bien (connexion internet) : <code>route -n
    Table de routage IP du noyau
    Destination     Passerelle      Genmask         Indic Metric Ref    Use Iface
    192.168.1.0     0.0.0.0         255.255.255.0   U     1      0        0 eth0
    169.254.0.0     0.0.0.0         255.255.0.0     U     1000   0        0 eth0
    0.0.0.0         192.168.1.1     0.0.0.0         UG    0      0        0 eth0
</code>
Mais lorsque l'on rebranche eth1, plus rien, on dirait que tout va sur eth1 au lieu de passer par eth0.
<code>route -n
    Table de routage IP du noyau
    Destination     Passerelle      Genmask         Indic Metric Ref    Use Iface
    192.168.1.0     0.0.0.0         255.255.255.0   U     1      0        0 eth0
    169.254.0.0     0.0.0.0         255.255.0.0     U     1000   0        0 eth0
    10.0.0.0        0.0.0.0         255.0.0.0       U     1      0        0 eth1
    0.0.0.0         10.0.0.1        0.0.0.0         UG    0      0        0 eth1
</code>
Dans //Informations de connexion// de Network-Manager, on retrouve les deux cartes. Mais eth1 est identifiée comme "Auto eth1 (default)" alors que eth0 l'est en "Auto eth0".

Pour résoudre cela graphiquement :
  * Clic droit sur l'applet de NetworkManager, << //Modification des connexions...// >>
  * << //Modifier// >> la carte eth1, onglet << //Paramètres IPv4// >>, bouton << //Routes...// >>
  * Cocher << //Utiliser cette connexion uniquement pour les ressources de son réseau// >> (Si activé, cette connexion ne sera jamais utilisée comme connexion réseau pas défaut)
Ou manuellement:
  * [[:tutoriel:comment_modifier_un_fichier|Modifier le fichier]] "''**/etc/NetworkManager/system-connections/Auto eth1**''"((**Attention** : Il n'y a qu'un seul fichier à éditer nommé 'Auto eth1' ... avec un blanc !))
  * Dans le groupe **[ipv4]**, ajouter : <file>never-default=true</file>


==== NetworkManager encore "endormi" en sortie de veille ====
Il se peux que le NetworkManager soit encore "endormi" en sortie de veille ((http://askubuntu.com/a/362148)) (cf. bugs launchpad [[https://launchpad.net/bugs/1184262|#1184262]] et [[https://launchpad.net/bugs/1234469|#1234469]]).

Pour voir l'etat du NetworkManager, taper ce qui suit dans un terminal de commandes :
  nmcli nm
Si le NetworkManager est effectivement encore "endormi", alors le retour de cette commande sera :
  RUNNING         STATE           WIFI-HARDWARE   WIFI       WWAN-HARDWARE   WWAN      
  running         asleep          enabled         enabled    enabled         disabled  
Il faut donc "réveiller" le NetworkManager en tapant la commde suivante :
  sudo nmcli nm sleep false
puis vérifier :
  nmcli nm
  RUNNING         STATE           WIFI-HARDWARE   WIFI       WWAN-HARDWARE   WWAN      
  running         connecting      enabled         enabled    enabled         disabled  
Pour automatiser la procedure, taper les commmandes suivantes :
<code>
cat <<EOF | sudo tee /etc/pm/sleep.d/network-manager-wakeup.sh >/dev/null
#!/usr/bin/env sh

case $1 in
    resume|thaw) nmcli nm sleep false;;
esac
EOF

sudo chmod +x /etc/pm/sleep.d/network-manager-wakeup.sh
</code>
Ce script (**''"network-manager-wakeup.sh"''**) sera exécuté automatiquement après chaque réveil de Linux :-)

====Connexions désactivées en sortie de veille====

 === Jusqu'à Ubuntu 14.10 ===
Il est possible que les connexions à internet (filaire et Wifi) soient désactivées en sortie du mode veille.
Pour les rétablir: 
  * Renommez [[:sudo|avec les droits administrateur]] le fichier ///var/lib/NetworkManager/NetworkManager.state// en ///var/lib/NetworkManager/NetworkManager.state.sauv//, avec la commande suivante: <code>sudo mv /var/lib/NetworkManager/NetworkManager.state /var/lib/NetworkManager/NetworkManager.state.sauv</code>
  * Redémarrez l'ordinateur.

Si cela ne marche pas essayez ceci:
  * Relevez le nom du pilote (par exemple "r8712u") :<code>lshw -class network | grep wireless | grep driver</code> et notez le nom du pilote,
  * Vérifiez que la commande qui suit affiche le même nom de pilote : <code>lsmod</code> par exemple : <code>lshw -class network | grep wireless | grep driver</code> vous renvoie: <code>configuration: broadcast=yes driver=r8712u ip=192.168.1.7 multicast=yes wireless=IEEE 802.11bg</code> et <code>lsmod</code> ceci: <code>r8712u                142855  0</code>
  * Tapez cette commande pour créer (ou modifier) le fichier **/etc/pm/config.d/load** (adaptez le nom du pilote en fonction du vôtre): <code>echo "SUSPEND_MODULES=r8712u" | sudo tee -a /etc/pm/config.d/load</code> Puis:<code>echo "MODULES_WHITELIST="r8712u" | sudo tee -a /etc/pm/config.d/load</code>

 === A partir d'Ubuntu 15.04 ===
Ubuntu étant passé à systemd depuis la version 15.04, la solution ci-dessus ne fonctionne plus. Une solution consiste à créer le fichier suivant:
  - Ouvrez un [[:terminal]] et exécutez la commande suivante : <code>sudo nano /lib/systemd/system/retablir_wifi_apres_veille.service</code> Entrez votre mot de passe.
  - Collez le contenu suivant: <file>​[Unit]
Description=Local system resume actions
After=suspend.target                                                            
                                                                                
[Service]                                                                       
Type=oneshot
ExecStart=/sbin/rmmod r8712u ; /sbin/modprobe r8712u

[Install]
WantedBy=suspend.target
</file>​ en remplaçant r8712u par le nom du pilote concerné en se référant à la méthode indiquée ci-dessus pour Ubuntu 14.10 pour le trouver. Faites Ctrl+X pour sauvegarder puis répondre O pour enregistrer les changements.
  -Lancer enfin les 2 commandes suivantes afin que le système prenne en compte le fichier et démarre le service: <code>sudo systemctl enable retablir_wifi_apres_veille
sudo systemctl start retablir_wifi_apres_veille</code>


==== Applet pour FluxBox ====

Si vous utilisez Fluxbox et n'avez pas envie de passer par le [[:terminal]] pour activer votre connexion Wi-Fi/filaire et que vous voulez le même gestionnaire réseau intégré que sous Ubuntu...

Il suffit d'[[:tutoriel:comment_modifier_un_fichier|éditer le fichier]]  //~/.fluxbox/startup// et d'ajouter la ligne suivante :
<file>
nm-applet &
</file>

Cela lancera l'applet automatiquement au démarrage de la session !


==== Éviter les saisies du mot de passe ====

Ce problème se pose uniquement quand vous activez l'ouverture de session automatique dans //Paramètres Système > Comptes utilisateur > Connexion automatique//.

===Solution sécurisée===

Il est possible d'éviter la saisie du mot de passe protégeant le trousseau de connexion même si l'ordi est configuré pour se connecter automatiquement sur un compte utilisateur (Système > Administration > Fenêtre de connexion > Se connecter automatiquement en tant que…). Il est donc possible d'avoir connexion automatique d'un utilisateur et l'établissement automatique d'une connexion WiFi sécurisée, sans saisir aucun mot de passe.

  * Démarrez le pc normalement en le laissant ouvrir la session utilisateur sélectionnée;
  * saisir (une dernière fois) le mot passe du //trousseau de connexion// pour établir la liaison WiFi;
  * Faites une recherche dans [[:unity#tableau_de_bord_dash|le tableau de bord Unity]] avec le mot clé "trousseau", ouvrez l'application **Mots de passe et clés**;
  * Ensuite dans le champs //Mots de passe//, faites un clic-droit sur sur //Connexion// et choisir //Modifier le mot de passe// en donnant le même mot de passe que pour l'ouverture de session (votre mot de passe utilisateur).

Il faut impérativement faire cette dernière étape, même si le mot de passe du trousseau est déjà le même que le mot de passe de connexion.

Après redémarrage de l'ordi, la connexion utilisateur et la connexion WiFi devraient se faire sans qu'il soit nécessaire de fournir un mot de passe. Toutefois, le trousseau ne se retrouve pas dans un état "déverrouillé", comme si on avait du saisir le mot de passe.

Cette solution fonctionne réellement, c'est indiscutable. Il se peut que son fonctionnement soit conditionné par d'autres réglages ou à l'installation de paquets spécifiques (lipamXX par exemple).


=== Solution non sécurisée ===

La solution dans ce cas est de supprimer le mot de passe du trousseau de clef.

<note important>Cette dernière pratique peut s'avérer dangereuse. Pour plus d'informations reportez vous à la page [[:desactiver_mots_de_passe#mot_de_passe_du_trousseau_de_cles]]</note>


Procédure :

  * Faites une recherche dans [[:unity#tableau_de_bord_dash|le tableau de bord Unity]] avec le mot clé "trousseau", ouvrez l'application **Mots de passe et clés**;
  * Ensuite dans le champs //Mots de passe//, faites un clic-droit sur //Connexion// et choisir //Modifier le mot de passe//;
  * Laisser le champ vide pour le nouveau mot de passe,
  * Valider avec le bouton //Utiliser un stockage non sûr//.

==== Network-manager ne démarre pas ====
===Solution 1===
Si le paquet firestarter est présent désinstallez le : 
<file>
sudo apt-get remove firestarter
</file>
===Solution 2===
Network-manager ne supporte pas bien d'être lancé 2 fois.

Pour éviter cela, modifiez la procédure d_start() du fichier /etc/init.d/network-manager pour avoir :

<file>sudo nano /etc/init.d/network-manager </file>

<file>
d_start() {
  # Ajout partie N°1:
     ps -e | grep NetworkManager
     if [ $? = 1 ]
     then
  # Fin ajout partie N°1
        start-stop-daemon --start --quiet --pidfile $PIDFILE \
                --exec $DAEMON -- $DAEMON_OPTS
  # Ajout partie N°2
    fi
  # Fin ajout partie N°2
}
</file>

===== Liens =====

  * Consultez la page [[:réseau]] pour obtenir des tonnes d'informations sur les réseaux, les outils et pages associés disponibles ;
  * [[https://wiki.gnome.org/Projects/NetworkManager|Site officiel]];
  * [[https://wiki.gnome.org/Projects/NetworkManager| Pour avoir plus de détail sur le fonctionnement de NetworkManager(en)]]
  * [[https://people.redhat.com/dcbw/NetworkManager/NetworkManager%20DBUS%20API.txt|Spécification de l'API dBus pour NetworkManager]] et aussi [[https://mail.gnome.org/archives/networkmanager-list/2006-October/msg00233.html|ici]];
  * Voir aussi [[:wicd]].

----

//Contributeurs : [[:utilisateurs:Narfight]], [[:utilisateurs:Id2ndR]], [[:utilisateurs:poupoul2]], [[:utilisateurs:kanor]], [[:utilisateurs:ashka]], [[http://forum.ubuntu-fr.org/profile.php?id=198416|f.x0]],[[:utilisateurs:metalux]]//